<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>StravaCoach - Dashboard</title>
<link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}" type="image/png">
<style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; }
    .container { max-width:700px; margin:2rem auto; background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:2rem; }

    /* Header corrig√© pour √©viter superposition */
    .header {
        background-color: #ef4423;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-align: left;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem 1rem;
    }
    .header-left {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        flex: 1 1 60%;
        min-width: 180px;
    }
    .header-left h1 {
        color: white;
        margin: 0;
        font-size: 2rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .header-left img {
        height: 50px;
    }
    .header-info {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem 1.5rem;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
    }
    .header-info p {
        margin: 0;
        white-space: nowrap;
    }
    .header-right {
        color: white;
        font-size: 1.1rem;
        font-weight: bold;
        flex: 1 1 30%;
        min-width: 120px;
        text-align: right;
        white-space: nowrap;
    }
    /* Ajout style pour l‚Äôemoji m√©t√©o */
    .header-right span.weather-emoji {
        font-size: 1.8rem;
        display: inline-block;
        margin-top: 0.2rem;
    }
    .powered {
        flex-basis: 100%;
        font-size: 0.7rem;
        color: white;
        text-align: center;
        margin-top: 0.3rem;
    }

    /* Responsive simplifi√© */
    @media (max-width: 600px) {
        .header-left, .header-right {
            flex: 1 1 100%;
            text-align: center;
        }
        .header-right {
            margin-top: 0.3rem;
        }
        .header-info {
            justify-content: center;
        }
    }

    /* Le reste de ton CSS existant */
    .type-coaching {
        color: white; 
        font-weight: bold; 
        font-size: 1rem; 
        margin: 0.7rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .type-coaching .date {
        font-weight: normal;
        font-size: 0.9rem;
    }
    .objectives, .short-term-comment { background-color: #f47a50; color: white; font-weight: bold; font-size: 0.9rem; text-align: center; border-radius: 6px; padding: 0.3rem; margin: 0.5rem 0; }
    .short-term-comment { background-color: #eee; color: #333; font-style: italic; }
    .next-runs table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    .next-runs th, .next-runs td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .next-runs th { background: #f47a50; color: white; }
    .sub-header { background-color: #f47a50; padding: 0.2rem 0.8rem; border-radius: 8px; text-align: center; margin: 2rem auto; }
    .sub-header h2 { color: white; margin: 0; font-size: 1.2rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem 2rem; margin-top: 1rem; }
    .stats-grid div { text-align: left; }
    .stats-grid .value { font-size: 1rem; font-weight: bold; }
    .stats-grid small { display: block; font-size: 0.7rem; color: #666; }
    canvas { width:100%; height:auto; margin-top:2rem; }
    .btn { display:block; width:100%; text-align:center; background:#007BFF; color:white; padding:10px; border-radius:5px; text-decoration:none; margin-top:1rem; }

    /* CARROUSEL PRINCIPAL */
    .carousel-container {
        position: relative;
        overflow: hidden;
        border-radius: 10px;
        background: #fff;
        padding: 0;
        margin-bottom: 2rem;
    }
    #mainCarouselSlides {
        display: flex;
        transition: transform 0.3s ease-in-out;
        will-change: transform;
    }
    .carousel-slide {
        min-width: 100%;
        box-sizing: border-box;
        padding: 0;
        user-select: none;
    }
	.carousel-arrows {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 0.5rem 0 1rem 0; /* espace entre header et contenu */
}

	.carousel-arrows button {
		background: #ef4423; /* fond orange */
		border: none;
		color: white; /* fl√®che blanche */
		font-size: 2rem;
		border-radius: 50%;
		width: 50px;
		height: 50px;
		cursor: pointer;
		transition: transform 0.2s;
	}

	.carousel-arrows button:hover {
		transform: scale(1.2);
	}


/* ======= Overlay plein √©cran pour graphiques ======= */
#chartOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}
#chartOverlay.open{ display: flex; }
#chartOverlay .overlay-content{
  position: relative;
  width: 95vw;
  height: 90vh;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  padding: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}
#chartOverlay .overlay-content canvas{
  width: 100% !important;
  height: 100% !important;
}
#chartOverlay .close-btn{
  position: absolute;
  top: 8px;
  right: 8px;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 1.2rem;
  background: #ef4423;
  color: #fff;
  cursor: pointer;
}

</style>
</head>
<body>
<div class="container">

    <!-- CARROUSEL PRINCIPAL -->
    {% if activities_for_carousel %}
	<div class="carousel-container" aria-label="Carrousel des activit√©s">

		<!-- ‚úÖ Fl√®ches sous le header -->
		<div class="carousel-arrows">
			<button id="mainPrevBtn" aria-label="Activit√© pr√©c√©dente">‚Äπ</button>
			<button id="mainNextBtn" aria-label="Activit√© suivante">‚Ä∫</button>
		</div>

		<div id="mainCarouselSlides">
			{% for act in activities_for_carousel %}
            <div class="carousel-slide" role="group" aria-roledescription="slide" aria-label="Activit√© {{ loop.index }} sur {{ activities_for_carousel|length }}">
                <div class="header">
                    <div class="header-left">
                        <h1>
                            <img src="{{ url_for('static', filename='icons/icon-192.png') }}" alt="StravaCoach">
                            StravaCoach
                        </h1>
			<div class="header-info">
				<p>
					Type : {{ act.type_sortie }}
					{% if act.is_fractionne %}
						‚Äî <span style="color:yellow;">Fractionn√© ‚úÖ ({{ (act.fractionne_prob * 100)|round(1) }}%)</span>
					{% else %}
						‚Äî <span style="color:lightgray;">Non fractionn√©</span>
					{% endif %}
				</p>
				<p>Date : {{ act.date }}</p>
			</div>
                    </div>
                    <div class="header-right">
                        {% if act.temperature is not none %}
                            Temp√©rature : {{ act.temperature }}¬∞C
                            <br />
                            <span class="weather-emoji">{{ act.weather_emoji }}</span>
                        {% else %}
                            Temp√©rature : N/A
                        {% endif %}
                    </div>
                    <div class="powered">powered by OpenAI</div>
                </div>

                <div class="type-coaching">
                    <div>Ton coaching de : {{ act.type_sortie }}</div>
                    <div class="date">le {{ act.date }}</div>
                </div>

                <div class="sub-header">
                    <h2>D√©tails du dernier run</h2>
                </div>
                <div class="stats-grid">
                    <div><small>Distance</small><div class="value">{{ act.distance_km }} km</div></div>
                    <div><small>FC Moy</small><div class="value">{{ act.fc_moy }}</div></div>
                    <div><small>D√©rive Cardiaque</small><div class="value">{{ act.deriv_cardio }}</div></div>
                    <div><small>Allure</small><div class="value">{{ act.allure }} /km</div></div>
                    <div><small>FC Max</small><div class="value">{{ act.fc_max }}</div></div>
                    <div><small>Gain Alt</small><div class="value">{{ act.gain_alt }} m</div></div>
                    <div><small>Temps</small><div class="value">{{ act.duration_min }} min</div></div>
                    <div><small>Cadence moy</small><div class="value">{{ act.cad_mean_spm }}<span class="unit">spm</span></div></div>
                    <div><small>Temp√©rature</small>
                        <div class="value">
                            {% if act.temperature is not none %}
                                {{ act.temperature }} ¬∞C
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="sub-header">
                    <h2>Allure, FC & √âl√©vation</h2>
                </div>
                <canvas id="chartGlobal{{ loop.index0 }}"></canvas>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    <!-- FIN CARROUSEL PRINCIPAL -->

    <!-- Commentaire court terme -->
    {% if short_term and short_term.commentaire %}
    <div class="short-term-comment">
        üìù {{ short_term.commentaire }}
    </div>
    {% endif %}

    <!-- Prochains runs (tableau) -->
    {% if short_term and short_term.prochains_runs %}
    <div class="next-runs">
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Distance (km)</th>
                    <th>Allure cible</th>
                </tr>
            </thead>
            <tbody>
            {% for run in short_term.prochains_runs %}
                <tr>
                    <td>{{ run.type }}</td>
                    <td>{{ run.distance }}</td>
                    <td>{{ run.allure }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Efficacit√© cardiaque (k) -->
    <div class="sub-header">
        <h2>√âvolution efficacit√© cardiaque (k)</h2>
    </div>
    <p style="font-size:0.85rem; color:#555; text-align:center; margin-top:-1rem;">
        k = 0.43 √ó (FC moy / allure min/km) - 5.19 ‚Äî Plus ton c≈ìur est efficient pour soutenir une allure donn√©e.
    </p>
    <canvas id="chartK"></canvas>

    <!-- D√©rive cardio -->
    <div class="sub-header">
        <h2>√âvolution d√©rive cardio</h2>
    </div>
    <p style="font-size:0.85rem; color:#555; text-align:center; margin-top:-1rem;">
        D√©rive cardio = Mesure l‚Äô√©volution de la charge cardio dans le temps, pendant un m√™me run, doit rester proche de 1.
    </p>
    <canvas id="chartDrift"></canvas>

    <a class="btn" href="/profile">‚öôÔ∏è Profil & √âv√©nements</a>
    <a class="btn" href="/generate_short_term_plan">üîÑ Recalculer coaching court terme</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Fonction utilitaire pour convertir les minutes d√©cimales en format mm:ss
function formatPace(minutesDecimal) {
    const minutes = Math.floor(minutesDecimal);
    const seconds = Math.round((minutesDecimal - minutes) * 60);
    const formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
    return `${minutes}:${formattedSeconds}`;
}

// CARROUSEL PRINCIPAL
(function(){
    const carousel = document.getElementById('mainCarouselSlides');
    if(!carousel) return;
    const slides = carousel.querySelectorAll('.carousel-slide');
    const prevBtn = document.getElementById('mainPrevBtn');
    const nextBtn = document.getElementById('mainNextBtn');
    const totalSlides = slides.length;
    let currentIndex = 0;

    function updateCarousel() {
        carousel.style.transform = `translateX(${-currentIndex * 100}%)`;
    }

	// Fl√®che gauche ‚Üí activit√© pr√©c√©dente
	prevBtn.addEventListener('click', () => {
		currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
		updateCarousel();
	});

	// Fl√®che droite ‚Üí activit√© suivante
	nextBtn.addEventListener('click', () => {
		currentIndex = (currentIndex + 1) % totalSlides;
		updateCarousel();
	});


    // Swipe support mobile
	let startX = 0;
	let isDragging = false;

	carousel.addEventListener('touchstart', (e) => {
		startX = e.touches[0].clientX;
		isDragging = true;
	});

	carousel.addEventListener('touchend', (e) => {
		if (!isDragging) return;
		const endX = e.changedTouches[0].clientX;
		const diffX = endX - startX;

		if (diffX > 40) {
			// Swipe vers la droite ‚Üí activit√© pr√©c√©dente
			currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
			updateCarousel();
		} else if (diffX < -40) {
			// Swipe vers la gauche ‚Üí activit√© suivante
			currentIndex = (currentIndex + 1) % totalSlides;
			updateCarousel();
		}
		isDragging = false;
	});

    updateCarousel();

    // Cr√©ation des graphiques Chart.js pour chaque slide
    {% for act in activities_for_carousel %}
    {
        const ctx{{ loop.index0 }} = document.getElementById('chartGlobal{{ loop.index0 }}').getContext('2d');
        const labels{{ loop.index0 }} = {{ act.labels | safe }};
        const fc{{ loop.index0 }} = {{ act.points_fc | safe }};
        const allure{{ loop.index0 }} = {{ act.allure_curve | safe }};
        const elevationData{{ loop.index0 }} = {{ act.points_alt | safe }};
        const minElevation{{ loop.index0 }} = elevationData{{ loop.index0 }}.length > 0 ? Math.min(...elevationData{{ loop.index0 }}) : 0;
        const newMinY2{{ loop.index0 }} = minElevation{{ loop.index0 }} - 5;
        const elevationLineColor = 'brown';

        new Chart(ctx{{ loop.index0 }}, {
            type: 'line',
            data: {
                labels: labels{{ loop.index0 }},
                datasets: [
                    { label: 'Allure (min/km)', data: allure{{ loop.index0 }}, borderColor:'blue', borderWidth:1.5, yAxisID:'y', fill:false, tension:0.8, pointRadius:0 },
                    { label: 'FC (bpm)', data: fc{{ loop.index0 }}, borderColor:'red', borderWidth:1.5, yAxisID:'y1', fill:false, tension:0.4, pointRadius:0 },
                    {
                        label: '√âl√©vation (m)',
                        data: elevationData{{ loop.index0 }},
                        borderColor: elevationLineColor,
                        borderWidth:1.5,
                        yAxisID:'y2',
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            gradient.addColorStop(0, elevationLineColor);
                            gradient.addColorStop(1, 'white');
                            return gradient;
                        },
                        fill:'start',
                        tension:0,
                        pointRadius:0
                    }
                ]
            },
            options: {
                responsive:true,
                plugins: { legend: { position:'bottom' }},
                scales: {
                    x: { title: { display: true, text: 'Distance (km)' }},
                    y: {
                        type:'linear',
                        position:'left',
                        min:3.5,
                        title: { display: true, text: 'Allure (min/km)' },
                        ticks: {
                            callback: function(value) {
                                return formatPace(value);
                            }
                        }
                    },
                    y1: {
                        type:'linear',
                        position:'right',
                        min:0,
                        grid:{drawOnChartArea:false},
                        title: { display: true, text: 'FC (bpm)' }
                    },
                    y2: {
                        type:'linear',
                        position:'right',
                        min: newMinY2{{ loop.index0 }},
                        max: 60,
                        grid:{drawOnChartArea:false},
                        title: { display: true, text: '√âl√©vation (m)' }
                    }
                }
            }
        });
    }
    {% endfor %}
})();

// GRAPHIQUES FIXES EN BAS
const elevationData = {{ dashboard.points_alt | safe }};
const minElevation = elevationData.length > 0 ? Math.min(...elevationData) : 0; 
const newMinY2 = minElevation - 5; 
const elevationLineColor = 'brown'; 

const labels = {{ dashboard.labels | safe }};
const ctx = document.getElementById('chartGlobal');
if(ctx){
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Allure (min/km)', data: {{ dashboard.allure_curve | safe }}, borderColor:'blue', borderWidth:1.5, yAxisID:'y', fill:false, tension:0.8, pointRadius:0 },
                { label: 'FC (bpm)', data: {{ dashboard.points_fc | safe }}, borderColor:'red', borderWidth:1.5, yAxisID:'y1', fill:false, tension:0.4, pointRadius:0 },
                {
                    label: '√âl√©vation (m)',
                    data: elevationData,
                    borderColor: elevationLineColor,
                    borderWidth:1.5,
                    yAxisID:'y2',
                    backgroundColor: function(context) {
                        const chart = context.chart;
                        const {ctx, chartArea} = chart;
                        if (!chartArea) return null;
                        const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                        gradient.addColorStop(0, elevationLineColor);
                        gradient.addColorStop(1, 'white');
                        return gradient;
                    },
                    fill:'start',
                    tension:0,
                    pointRadius:0
                }
            ]
        },
        options: {
            responsive:true,
            plugins: { legend: { position:'bottom' }},
            scales: {
                x: {
                    title: { display: true, text: 'Distance (km)' }
                },
                y: {
                    type:'linear',
                    position:'left',
                    min:3.5,
                    title: { display: true, text: 'Allure (min/km)' },
                    ticks: {
                        callback: function(value) {
                            return formatPace(value);
                        }
                    }
                },
                y1: { 
                    type:'linear', 
                    position:'right', 
                    min:0, 
                    grid:{drawOnChartArea:false}, 
                    title: { display: true, text: 'FC (bpm)' }
                },
                y2: {
                    type:'linear',
                    position:'right',
                    min: newMinY2,
                    max: 60,
                    grid:{drawOnChartArea:false},
                    title: { display: true, text: '√âl√©vation (m)' }
                }
            }
        }
    });
}

const ctxK = document.getElementById('chartK').getContext('2d');
const chartK = new Chart(ctxK, {
    type: 'line',
    data: {
        labels: {{ dashboard.history_dates | safe }},
        datasets: [{
            label: 'Efficacit√© Cardiaque (k)',
            data: {{ dashboard.history_k | safe }},
            borderColor: 'purple',
            borderWidth: 1.5,
            fill: false,
            tension: 0.4,
            pointRadius: 3
        }]
    },
    options: {
        responsive:true,
        plugins: { legend: { position:'bottom' }},
        scales: {
            x: { title: { display: true, text: 'Date' }},
            y: { title: { display: true, text: 'k' }}
        }
    }
});

const ctxDrift = document.getElementById('chartDrift').getContext('2d');
const chartDrift = new Chart(ctxDrift, {
    type: 'line',
    data: {
        labels: {{ dashboard.history_dates | safe }},
        datasets: [{
            label: 'D√©rive Cardio',
            data: {{ dashboard.history_drift | safe }},
            borderColor: 'orange',
            borderWidth: 1.5,
            fill: false,
            tension: 0.4,
            pointRadius: 3
        }]
    },
    options: {
        responsive:true,
        plugins: { legend: { position:'bottom' }},
        scales: {
            x: { title: { display: true, text: 'Date' }},
            y: { title: { display: true, text: 'D√©rive cardio' }}
        }
    }
});


// ====== Helpers for fullscreen font scaling ======
const __chartPrevFonts = new WeakMap();

function adjustChartFonts(chart, mode){
  if(!chart) return;
  const scales = chart.options.scales || {};
  const legend = chart.options.plugins && chart.options.plugins.legend ? chart.options.plugins.legend : null;

  if(mode === 'fullscreen'){
    // Save current sizes once
    if(!__chartPrevFonts.has(chart)){
      __chartPrevFonts.set(chart, {
        xTick: (scales.x && scales.x.ticks && scales.x.ticks.font && scales.x.ticks.font.size) || 12,
        yTick: (scales.y && scales.y.ticks && scales.y.ticks.font && scales.y.ticks.font.size) || 12,
        y1Tick: (scales.y1 && scales.y1.ticks && scales.y1.ticks.font && scales.y1.ticks.font.size) || 12,
        y2Tick: (scales.y2 && scales.y2.ticks && scales.y2.ticks.font && scales.y2.ticks.font.size) || 12,
        xTitle: (scales.x && scales.x.title && scales.x.title.font && scales.x.title.font.size) || 12,
        yTitle: (scales.y && scales.y.title && scales.y.title.font && scales.y.title.font.size) || 12,
        y1Title: (scales.y1 && scales.y1.title && scales.y1.title.font && scales.y1.title.font.size) || 12,
        y2Title: (scales.y2 && scales.y2.title && scales.y2.title.font && scales.y2.title.font.size) || 12,
        legend: (legend && legend.labels && legend.labels.font && legend.labels.font.size) || 12,
      });
    }

    // Compute a base size from canvas width
    const w = chart.canvas.clientWidth || 800;
    const base = Math.max(14, Math.min(24, Math.round(w / 48))); // scale between 14 and 24

    if(scales.x){
      scales.x.ticks = scales.x.ticks || {};
      scales.x.ticks.font = Object.assign({}, scales.x.ticks.font, { size: base });
      if(scales.x.title){
        scales.x.title.font = Object.assign({}, scales.x.title.font, { size: base });
      }
    }
    if(scales.y){
      scales.y.ticks = scales.y.ticks || {};
      scales.y.ticks.font = Object.assign({}, scales.y.ticks.font, { size: base });
      if(scales.y.title){
        scales.y.title.font = Object.assign({}, scales.y.title.font, { size: base });
      }
    }
    if(scales.y1){
      scales.y1.ticks = scales.y1.ticks || {};
      scales.y1.ticks.font = Object.assign({}, scales.y1.ticks.font, { size: base });
      if(scales.y1.title){
        scales.y1.title.font = Object.assign({}, scales.y1.title.font, { size: base });
      }
    }
    if(scales.y2){
      scales.y2.ticks = scales.y2.ticks || {};
      scales.y2.ticks.font = Object.assign({}, scales.y2.ticks.font, { size: base });
      if(scales.y2.title){
        scales.y2.title.font = Object.assign({}, scales.y2.title.font, { size: base });
      }
    }
    if(legend){
      legend.labels = legend.labels || {};
      legend.labels.font = Object.assign({}, legend.labels.font, { size: base });
    }
  } else {
    // restore
    const prev = __chartPrevFonts.get(chart);
    const def = 12;
    if(scales.x){
      scales.x.ticks = scales.x.ticks || {};
      scales.x.ticks.font = Object.assign({}, scales.x.ticks.font, { size: prev ? prev.xTick : def });
      if(scales.x.title){
        scales.x.title.font = Object.assign({}, scales.x.title.font, { size: prev ? prev.xTitle : def });
      }
    }
    if(scales.y){
      scales.y.ticks = scales.y.ticks || {};
      scales.y.ticks.font = Object.assign({}, scales.y.ticks.font, { size: prev ? prev.yTick : def });
      if(scales.y.title){
        scales.y.title.font = Object.assign({}, scales.y.title.font, { size: prev ? prev.yTitle : def });
      }
    }
    if(scales.y1){
      scales.y1.ticks = scales.y1.ticks || {};
      scales.y1.ticks.font = Object.assign({}, scales.y1.ticks.font, { size: prev ? prev.y1Tick : def });
      if(scales.y1.title){
        scales.y1.title.font = Object.assign({}, scales.y1.title.font, { size: prev ? prev.y1Title : def });
      }
    }
    if(scales.y2){
      scales.y2.ticks = scales.y2.ticks || {};
      scales.y2.ticks.font = Object.assign({}, scales.y2.ticks.font, { size: prev ? prev.y2Tick : def });
      if(scales.y2.title){
        scales.y2.title.font = Object.assign({}, scales.y2.title.font, { size: prev ? prev.y2Title : def });
      }
    }
    if(legend){
      legend.labels = legend.labels || {};
      legend.labels.font = Object.assign({}, legend.labels.font, { size: prev ? prev.legend : def });
    }
  }
  chart.update('none');
}

// ======= Overlay plein √©cran pour graphiques =======
(function(){
  // Cr√©e l'overlay au chargement
  const overlay = document.createElement('div');
  overlay.id = 'chartOverlay';
  overlay.innerHTML = '<div class="overlay-content"><button class="close-btn" aria-label="Fermer">‚úï</button></div>';
  document.body.appendChild(overlay);
  const content = overlay.querySelector('.overlay-content');
  const closeBtn = overlay.querySelector('.close-btn');

  // M√©morise l'emplacement d'origine de chaque canvas
  const originalPlace = new Map();

  function openOverlay(canvas){
    if(!originalPlace.has(canvas)){
      originalPlace.set(canvas, { parent: canvas.parentNode, next: canvas.nextSibling });
    }
    content.appendChild(canvas);
    overlay.classList.add('open');

    // Forcer Chart.js √† s'ajuster
    try{
      const chart = Chart.getChart(canvas);
      if(chart){
        chart.options.maintainAspectRatio = false;
        // Ajuste polices en plein √©cran
        adjustChartFonts(chart, 'fullscreen');
        // Laisse le DOM peindre l'overlay puis resize
        requestAnimationFrame(() => {
          requestAnimationFrame(() => chart.resize());
        });
      }
    }catch(e){ /* ignore */ }
  }

  function closeOverlay(){
    const canvas = content.querySelector('canvas');
    if(!canvas) { overlay.classList.remove('open'); return; }
    const meta = originalPlace.get(canvas);
    if(meta){
      if(meta.next){ meta.parent.insertBefore(canvas, meta.next); }
      else { meta.parent.appendChild(canvas); }
    }
    overlay.classList.remove('open');

    // Restaure le comportement par d√©faut
    try{
      const chart = Chart.getChart(canvas);
      if(chart){
        chart.options.maintainAspectRatio = true;
        adjustChartFonts(chart, 'normal');
        requestAnimationFrame(() => chart.resize());
      }
    }catch(e){ /* ignore */ }
  }

  // Ouvrir au tap/clic sur n'importe quel canvas
  document.querySelectorAll('canvas').forEach((c) => {
    c.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openOverlay(c);
    }, {passive:false});
  });

  // Fermer : bouton, clic en dehors du canvas, touche √âchap
  closeBtn.addEventListener('click', closeOverlay);
  overlay.addEventListener('click', (e) => {
    if(e.target === overlay) closeOverlay();
  });
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' && overlay.classList.contains('open')) closeOverlay();
  });
})();
</script>
</body>
</html>
