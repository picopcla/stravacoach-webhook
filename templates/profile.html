<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Profil</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        table, th, td { border: 1px solid #ccc; }
        th, td { padding: 8px; text-align: left; }
        button { padding: 5px 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <h2>Profil</h2>
    <form id="profileForm" method="POST">
        <label>Date de naissance :</label>
        <input type="date" name="birth_date" id="birth_date" value="{{ profile.birth_date }}">
        <span id="ageDisplay"></span><br><br>

        <label>Poids (kg) :</label>
        <input type="number" step="0.1" name="weight" value="{{ profile.weight }}"><br><br>

        <h3>Ã‰vÃ©nements Ã  venir</h3>
        <table id="eventsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Nom</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for event in profile.events %}
                <tr>
                    <td><input type="date" name="event_date" value="{{ event.date }}"></td>
                    <td><input type="text" name="event_name" value="{{ event.name }}"></td>
                    <td><button type="button" onclick="removeRow(this)">ðŸ—‘</button></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="button" onclick="addRow()">+ Ajouter Ã©vÃ©nement</button><br><br>

        <button type="submit">Enregistrer</button>
    </form>

    <script>
        function addRow() {
            const table = document.getElementById("eventsTable").getElementsByTagName('tbody')[0];
            const row = table.insertRow();
            row.innerHTML = `
                <td><input type="date" name="event_date"></td>
                <td><input type="text" name="event_name"></td>
                <td><button type="button" onclick="removeRow(this)">ðŸ—‘</button></td>
            `;
        }

        function removeRow(btn) {
            btn.parentNode.parentNode.remove();
        }

        function calcAge() {
            const birth = document.getElementById('birth_date').value;
            const ageDisplay = document.getElementById('ageDisplay');
            if (birth) {
                const birthDate = new Date(birth);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                ageDisplay.textContent = `(${age} ans)`;
            } else {
                ageDisplay.textContent = '';
            }
        }

        document.getElementById('birth_date').addEventListener('input', calcAge);
        window.onload = calcAge;

        // message aprÃ¨s POST
        {% if saved %}
        alert("âœ… Profil enregistrÃ© !");
        window.location.href = "/";
        {% endif %}
    </script>
</body>
</html>
